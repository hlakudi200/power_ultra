# Send Activation Code Edge Function

## Overview
This document describes the new `send-activation-code` edge function that automatically emails activation codes to members when generated by admins.

## Location
`supabase/functions/send-activation-code/index.ts`

## Purpose
When an admin generates an activation code through the UI, this edge function:
1. Sends a beautifully formatted email to the member
2. Includes the activation code prominently
3. Provides membership details (plan name, duration, expiry)
4. Includes a direct link to activate the membership
5. Follows the existing dark theme email design pattern

## Email Template Features

### Dark Theme Design
- Background: `#121212`
- Card background: `#1A1A1A`
- Primary color: `#E53E3E` (red gradient)
- Text: `#F5F5F5` with muted colors for secondary info

### Content Includes
1. **Activation Code Box** - Large, prominent display with gradient background
2. **Membership Details Table**:
   - Plan name
   - Duration (months)
   - Code expiry date
3. **Step-by-step activation instructions**
4. **CTA button** linking to `/activate-membership`
5. **Contact information**

## Integration

### Called From
`src/components/admin/GenerateActivationCodeDialog.tsx` (lines 131-171)

### Request Format
```typescript
POST /functions/v1/send-activation-code
{
  memberName: string,
  memberEmail: string,
  activationCode: string,
  membershipName: string,
  durationMonths: number,
  expiresAt: string (ISO date)
}
```

### Response Format
```typescript
Success (200):
{
  message: "Activation code sent successfully",
  info: { ... nodemailer response }
}

Error (400/500):
{
  error: string
}
```

## Error Handling

The frontend handles email failures gracefully:
- **Email succeeds**: Toast shows "Code Generated & Sent!"
- **Email fails**: Toast shows "Code Generated!" with note to share manually
- **Code generation fails**: Shows error toast and stops (no email sent)

This ensures admins can always copy the code from the UI if email delivery fails.

## Email Service

Uses Nodemailer with Gmail SMTP (same as all other emails):
- Host: `smtp.gmail.com`
- Port: `465` (SSL)
- Auth: `GMAIL_USER` and `GMAIL_APP_PASSWORD` environment variables

## Setup Required

### 1. Deploy Edge Function
```bash
supabase functions deploy send-activation-code
```

### 2. Set Environment Variables
```bash
supabase secrets set GMAIL_USER=your-email@gmail.com
supabase secrets set GMAIL_APP_PASSWORD=your-app-password
```

### 3. Update URLs in Code
Replace these placeholders in `index.ts`:
- `[YOUR_WEBSITE_URL]` - Your production website URL
  - Used for logo image
  - Used for activation link

Example:
```typescript
const LOGO_URL = "https://powerultragym.com/logo.png";
const ACTIVATION_URL = "https://powerultragym.com/activate-membership";
```

## Testing

### Test Email Delivery
1. Go to Admin → Members page
2. Click the Ticket icon next to any member
3. Fill in the activation code form
4. Click "Generate Code"
5. Check member's email for the activation code email
6. Verify code format is correct: `PUGS-XXXX-XXXX-XXXX`

### Expected Behavior
- Admin sees success toast
- Member receives email within seconds
- Email displays correctly in dark theme
- Activation link navigates to correct page
- Code can be copied and used

## Workflow

```
Admin generates code
    ↓
Database function creates code
    ↓
Frontend receives code
    ↓
Frontend calls send-activation-code edge function
    ↓
Edge function sends email via Nodemailer
    ↓
Member receives email
    ↓
Member clicks link or enters code manually
    ↓
Membership activated
```

## Related Files

- **Edge Function**: `supabase/functions/send-activation-code/index.ts`
- **Database Function**: `database_sql/fix_generate_activation_code_function.sql`
- **Admin Dialog**: `src/components/admin/GenerateActivationCodeDialog.tsx`
- **User Activation Page**: `src/pages/ActivateMembership.tsx`
- **Email Pattern Reference**: `supabase/functions/send-booking-confirmation/index.ts`

## Notes

- Email sending is asynchronous and doesn't block code generation
- If email fails, code is still generated and displayed in UI
- Admins can always copy the code and send it manually via WhatsApp/SMS
- Email template matches all other Power Ultra Gym emails (dark theme)
